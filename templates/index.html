<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- [SEO] Meta Tags -->
    <title>{{ meta_title }}</title>
    <meta name="description" content="{{ meta_desc }}">
    <link rel="canonical" href="{{ meta_url }}">

    <!-- [SEO] Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ meta_url }}">
    <meta property="og:title" content="{{ meta_title }}">
    <meta property="og:description" content="{{ meta_desc }}">
    <meta property="og:site_name" content="JP Campus">
    
    <!-- [SEO] JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": "JP Campus",
      "url": "https://jpcampus.net/",
      "potentialAction": {
        "@type": "SearchAction",
        "target": "https://jpcampus.net/?q={search_term_string}",
        "query-input": "required name=search_term_string"
      }
    }
    </script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EDJL0618LL"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-EDJL0618LL');
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Noto Sans KR', sans-serif; overflow: hidden; }
        
        header {
            position: absolute; top: 0; left: 0; width: 100%; z-index: 10;
            background: rgba(255, 255, 255, 0.98); box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 10px 0 15px 0; display: flex; flex-direction: column; align-items: center;
        }
        
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; max-width: 1200px; padding: 0 15px; box-sizing: border-box; margin-bottom: 10px;
        }
        .logo { font-size: 1.4rem; font-weight: 800; color: #2c3e50; text-decoration: none; }
        .logo span { color: #3498db; }
        
        .lang-switch { display: flex; gap: 8px; }
        .lang-btn {
            background: none; border: 1px solid #ddd; border-radius: 4px; 
            cursor: pointer; font-size: 1.2rem; padding: 2px 5px;
        }
        .lang-btn:hover { background: #f0f0f0; }

        .search-container {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; 
            padding: 0 15px; width: 100%; max-width: 1200px; box-sizing: border-box;
        }
        select { width: 100%; padding: 10px 8px; border-radius: 8px; border: 1px solid #e0e0e0; background: #f9f9f9; font-size: 0.9rem; }

        .search-btn-container { width: 100%; max-width: 1200px; padding: 10px 15px 0; box-sizing: border-box; }
        .search-btn {
            width: 100%; background-color: #2c3e50; color: white; border: none;
            padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: background 0.2s;
        }
        .search-btn:hover { background-color: #34495e; }
        
        .result-bar { margin-top: 8px; font-size: 0.85rem; color: #666; font-weight: 600; }
        .highlight { color: #e74c3c; }

        #map { width: 100%; height: 100vh; padding-top: 220px; box-sizing: border-box; }
        
        @media (max-width: 768px) {
            .search-container { grid-template-columns: repeat(2, 1fr); }
            #map { padding-top: 280px !important; }
        }

        .info-window { padding: 5px; min-width: 200px; }
        .info-title { font-weight: bold; font-size: 1rem; color: #2c3e50; margin-bottom: 5px; display: block; border-bottom: 1px solid #eee; padding-bottom: 5px; text-decoration: none; }
        .info-body { font-size: 0.85rem; color: #555; line-height: 1.6; }
    </style>
</head>
<body>

    <header>
        <div class="top-bar">
            <a href="/" class="logo">JP<span>Campus</span></a>
            <div class="lang-switch">
                <button class="lang-btn" onclick="setLanguage('ko')">ğŸ‡°ğŸ‡·</button>
                <button class="lang-btn" onclick="setLanguage('ja')">ğŸ‡¯ğŸ‡µ</button>
                <button class="lang-btn" onclick="setLanguage('en')">ğŸ‡ºğŸ‡¸</button>
            </div>
        </div>
        
        <div class="search-container">
            <select id="filter-region">
                <option value="all" data-i18n="opt_region_all">ğŸ“ ì§€ì—­ (ì „ì²´)</option>
                <option value="æ–°å®¿" data-i18n="opt_shinjuku">ì‹ ì£¼ì¿ </option>
                <option value="é«˜ç”°é¦¬å ´" data-i18n="opt_takadanobaba">ë‹¤ì¹´ë‹¤ë…¸ë°”ë°”</option>
                <option value="å¤§ä¹…ä¿" data-i18n="opt_shinokubo">ì‹ ì˜¤ì¿ ë³´</option>
                <option value="æ± è¢‹" data-i18n="opt_ikebukuro">ì´ì¼€ë¶€ì¿ ë¡œ</option>
                <option value="åƒè‘‰" data-i18n="opt_chiba">ì¹˜ë°”í˜„ (ì „ì²´)</option>
                <option value="èˆ¹æ©‹" data-i18n="opt_funabashi">í›„ë‚˜ë°”ì‹œ</option>
            </select>
            <select id="filter-nation">
                <option value="all" data-i18n="opt_nation_all">ğŸŒ êµ­ì  ë¹„ìœ¨ (ì „ì²´)</option>
                <option value="korea_low" data-i18n="opt_kr_low">ğŸ‡°ğŸ‡· í•œêµ­ì¸ ì ì€ ê³³</option>
                <option value="china_high" data-i18n="opt_cn_high">ğŸ‡¨ğŸ‡³ ì¤‘êµ­ í•™ìƒ ìœ„ì£¼</option>
            </select>
            <select id="filter-price">
                <option value="all" data-i18n="opt_price_all">ğŸ’° í•™ë¹„ (ì „ì²´)</option>
                <option value="75" data-i18n="opt_price_75">75ë§Œì—” â†“</option>
                <option value="78" data-i18n="opt_price_78">78ë§Œì—” â†“</option>
                <option value="82" data-i18n="opt_price_82">82ë§Œì—” â†“</option>
            </select>
            <select id="filter-dorm">
                <option value="all" data-i18n="opt_dorm_all">ğŸ›ï¸ ê¸°ìˆ™ì‚¬ (ì „ì²´)</option>
                <option value="yes" data-i18n="opt_dorm_yes">ìˆìŒ</option>
            </select>
            <select id="filter-scale">
                <option value="all" data-i18n="opt_scale_all">ğŸ‘¥ ê·œëª¨ (ì „ì²´)</option>
                <option value="large" data-i18n="opt_scale_large">ëŒ€ê·œëª¨</option>
                <option value="small" data-i18n="opt_scale_small">ì†Œìˆ˜ì •ì˜ˆ</option>
            </select>
            <select id="filter-career">
                <option value="all" data-i18n="opt_career_all">ğŸ“ ì§„í•™ (ì „ì²´)</option>
                <option value="grad_school" data-i18n="opt_career_grad">ëŒ€í•™ì›</option>
                <option value="university" data-i18n="opt_career_univ">ëŒ€í•™</option>
            </select>
            <select id="filter-history">
                <option value="all" data-i18n="opt_hist_all">ğŸ“œ ì—­ì‚¬ (ì „ì²´)</option>
                <option value="old" data-i18n="opt_hist_old">ì „í†µìˆìŒ</option>
            </select>
            <select id="filter-term">
                <option value="all" data-i18n="opt_term_all">ğŸ“… ì…í•™ (ì „ì²´)</option>
                <option value="4" data-i18n="opt_term_4">4ì›”</option>
                <option value="10" data-i18n="opt_term_10">10ì›”</option>
            </select>
        </div>

        <div class="search-btn-container">
            <button class="search-btn" onclick="applyFilters()" data-i18n="btn_search">ğŸ” ì¡°ê±´ìœ¼ë¡œ ê²€ìƒ‰í•˜ê¸°</button>
        </div>
        <div class="result-bar">
            <span data-i18n="txt_result">ê²€ìƒ‰ ê²°ê³¼:</span> 
            <span class="highlight" id="result-count">{{ schools_json|safe|length }}</span>
            <span data-i18n="txt_schools">ê°œì˜ í•™êµ</span>
        </div>
    </header>

    <div id="map"></div>

    <script>
        // === ë‹¤êµ­ì–´ ë°ì´í„° ===
        const translations = {
            ko: {
                opt_region_all: "ğŸ“ ì§€ì—­ (ì „ì²´)", opt_shinjuku: "ì‹ ì£¼ì¿ ", opt_takadanobaba: "ë‹¤ì¹´ë‹¤ë…¸ë°”ë°”", opt_shinokubo: "ì‹ ì˜¤ì¿ ë³´", opt_ikebukuro: "ì´ì¼€ë¶€ì¿ ë¡œ",
                opt_chiba: "ì¹˜ë°”í˜„ (ì „ì²´)", opt_funabashi: "í›„ë‚˜ë°”ì‹œ",
                opt_nation_all: "ğŸŒ êµ­ì  ë¹„ìœ¨ (ì „ì²´)", opt_kr_low: "ğŸ‡°ğŸ‡· í•œêµ­ì¸ ì ì€ ê³³", opt_cn_high: "ğŸ‡¨ğŸ‡³ ì¤‘êµ­ í•™ìƒ ìœ„ì£¼",
                opt_price_all: "ğŸ’° í•™ë¹„ (ì „ì²´)", opt_price_75: "75ë§Œì—” â†“", opt_price_78: "78ë§Œì—” â†“", opt_price_82: "82ë§Œì—” â†“",
                opt_dorm_all: "ğŸ›ï¸ ê¸°ìˆ™ì‚¬ (ì „ì²´)", opt_dorm_yes: "ìˆìŒ",
                opt_scale_all: "ğŸ‘¥ ê·œëª¨ (ì „ì²´)", opt_scale_large: "ëŒ€ê·œëª¨", opt_scale_small: "ì†Œìˆ˜ì •ì˜ˆ",
                opt_career_all: "ğŸ“ ì§„í•™ (ì „ì²´)", opt_career_grad: "ëŒ€í•™ì›", opt_career_univ: "ëŒ€í•™",
                opt_hist_all: "ğŸ“œ ì—­ì‚¬ (ì „ì²´)", opt_hist_old: "ì „í†µìˆìŒ",
                opt_term_all: "ğŸ“… ì…í•™ (ì „ì²´)", opt_term_4: "4ì›”", opt_term_10: "10ì›”",
                btn_search: "ğŸ” ì¡°ê±´ìœ¼ë¡œ ê²€ìƒ‰í•˜ê¸°", txt_result: "ê²€ìƒ‰ ê²°ê³¼:", txt_schools: "ê°œì˜ í•™êµ",
                inf_fee: "í•™ë¹„", inf_ppl: "ëª…"
            },
            ja: {
                opt_region_all: "ğŸ“ åœ°åŸŸ (å…¨ã¦)", opt_shinjuku: "æ–°å®¿", opt_takadanobaba: "é«˜ç”°é¦¬å ´", opt_shinokubo: "æ–°å¤§ä¹…ä¿", opt_ikebukuro: "æ± è¢‹",
                opt_chiba: "åƒè‘‰çœŒ (å…¨ã¦)", opt_funabashi: "èˆ¹æ©‹",
                opt_nation_all: "ğŸŒ å›½ç±æ¯”ç‡ (å…¨ã¦)", opt_kr_low: "ğŸ‡°ğŸ‡· éŸ“å›½äººå°‘ãªã‚", opt_cn_high: "ğŸ‡¨ğŸ‡³ ä¸­å›½äººä¸­å¿ƒ",
                opt_price_all: "ğŸ’° å­¦è²» (å…¨ã¦)", opt_price_75: "75ä¸‡å†† â†“", opt_price_78: "78ä¸‡å†† â†“", opt_price_82: "82ä¸‡å†† â†“",
                opt_dorm_all: "ğŸ›ï¸ å¯® (å…¨ã¦)", opt_dorm_yes: "ã‚ã‚Š",
                opt_scale_all: "ğŸ‘¥ è¦æ¨¡ (å…¨ã¦)", opt_scale_large: "å¤§è¦æ¨¡", opt_scale_small: "å°‘äººæ•°",
                opt_career_all: "ğŸ“ é€²å­¦ (å…¨ã¦)", opt_career_grad: "å¤§å­¦é™¢", opt_career_univ: "å¤§å­¦",
                opt_hist_all: "ğŸ“œ æ­´å² (å…¨ã¦)", opt_hist_old: "ä¼çµ±æ ¡",
                opt_term_all: "ğŸ“… å…¥å­¦ (å…¨ã¦)", opt_term_4: "4æœˆ", opt_term_10: "10æœˆ",
                btn_search: "ğŸ” æ¡ä»¶ã§æ¤œç´¢ã™ã‚‹", txt_result: "æ¤œç´¢çµæœ:", txt_schools: "æ ¡",
                inf_fee: "å­¦è²»", inf_ppl: "å"
            },
            en: {
                opt_region_all: "ğŸ“ Region (All)", opt_shinjuku: "Shinjuku", opt_takadanobaba: "Takadanobaba", opt_shinokubo: "Shin-Okubo", opt_ikebukuro: "Ikebukuro",
                opt_chiba: "Chiba Pref. (All)", opt_funabashi: "Funabashi",
                opt_nation_all: "ğŸŒ Nationality (All)", opt_kr_low: "ğŸ‡°ğŸ‡· Low Korean Ratio", opt_cn_high: "ğŸ‡¨ğŸ‡³ Chinese Majority",
                opt_price_all: "ğŸ’° Tuition (All)", opt_price_75: "Â¥750k â†“", opt_price_78: "Â¥780k â†“", opt_price_82: "Â¥820k â†“",
                opt_dorm_all: "ğŸ›ï¸ Dormitory (All)", opt_dorm_yes: "Available",
                opt_scale_all: "ğŸ‘¥ Size (All)", opt_scale_large: "Large", opt_scale_small: "Small Group",
                opt_career_all: "ğŸ“ Career (All)", opt_career_grad: "Grad School", opt_career_univ: "University",
                opt_hist_all: "ğŸ“œ History (All)", opt_hist_old: "Established",
                opt_term_all: "ğŸ“… Admission (All)", opt_term_4: "April", opt_term_10: "October",
                btn_search: "ğŸ” Search", txt_result: "Results:", txt_schools: " schools",
                inf_fee: "Fee", inf_ppl: "students"
            }
        };

        let currentLang = localStorage.getItem('lang') || 'ko';

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);
            
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });
            applyFilters();
        }

        // === ì§€ë„ ë¡œì§ ===
        const schools = {{ schools_json | safe }};
        let map;
        let markers = [];
        let infoWindow;

        function initMap() {
            // ì´ˆê¸° ì¤‘ì‹¬ì ì€ ë„ì¿„ì§€ë§Œ, ì¹˜ë°” ë°ì´í„°ê°€ ë§ì•„ì§€ë©´ ì¤Œ ë ˆë²¨ ì¡°ì • í•„ìš”í•  ìˆ˜ ìˆìŒ
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 35.699, lng: 139.700 },
                zoom: 11,
                mapTypeControl: false, fullscreenControl: false, streetViewControl: false
            });

            infoWindow = new google.maps.InfoWindow();
            setLanguage(currentLang);
        }

        function applyFilters() {
            const region = document.getElementById('filter-region').value;
            const price = document.getElementById('filter-price').value;
            const nation = document.getElementById('filter-nation').value;
            
            const filtered = schools.filter(s => {
                const info = s.basic_info || {};
                const courses = s.courses || [];
                const fees = (courses.length > 0) ? parseInt(courses[0].total_fees) : 9999999;
                const addr = info.address || "";
                
                // ì§€ì—­ í•„í„° (ë‹¨ìˆœ ë¬¸ìì—´ í¬í•¨)
                if (region !== 'all' && !addr.includes(region)) return false;
                if (price !== 'all' && fees > (parseInt(price) * 10000)) return false;
                
                const demo = s.student_demographics || { total: 0 };
                if (nation === 'korea_low' && demo.total > 0 && (demo.korea / demo.total) > 0.1) return false;
                if (nation === 'china_high' && demo.total > 0 && (demo.china / demo.total) < 0.5) return false;

                return true;
            });

            updateMarkers(filtered);
            document.getElementById('result-count').innerText = filtered.length;
        }

        function updateMarkers(data) {
            markers.forEach(m => m.setMap(null));
            markers = [];
            const t = translations[currentLang];

            data.forEach(school => {
                if (!school.location || !school.location.lat) return;
                
                const marker = new google.maps.Marker({
                    position: { lat: parseFloat(school.location.lat), lng: parseFloat(school.location.lng) },
                    map: map,
                    title: school.basic_info.name_ja
                });

                marker.addListener("click", () => {
                    const total = school.student_demographics ? school.student_demographics.total : 0;
                    let fee = "-";
                    if (school.courses && school.courses.length > 0) {
                        const rawFee = parseInt(school.courses[0].total_fees);
                        fee = (currentLang === 'en') ? `Â¥${(rawFee/1000).toFixed(0)}k` : `${(rawFee/10000).toFixed(0)}ä¸‡`;
                    }

                    const content = `
                        <div class="info-window">
                            <a href="/school/${school.id}" class="info-title">${school.basic_info.name_ja}</a>
                            <div class="info-body">
                                ğŸ“ ${school.basic_info.address.replace('æ±äº¬éƒ½', '').replace('åƒè‘‰çœŒ', '')}<br>
                                ğŸ’° ${t.inf_fee}: ${fee} / ğŸ‘¥ ${total}${t.inf_ppl}
                            </div>
                        </div>
                    `;
                    infoWindow.setContent(content);
                    infoWindow.open(map, marker);
                });
                markers.push(marker);
            });
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&callback=initMap&v=weekly" async defer></script>
</body>
</html>